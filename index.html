<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes and Tasks App</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.2.2/dist/pouchdb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pouchdb-authentication@1.1.3/dist/pouchdb.authentication.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid/dist/umd/uuid.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="nav-links">
            <a onclick="showPage('notes')">Notes</a>
            <a onclick="showPage('tasks')">Tasks</a>
        </div>
        <div class="action-buttons">
            <button onclick="showNoteForm()"><i class="fas fa-plus"></i> Note</button>
            <button onclick="showTaskForm()"><i class="fas fa-plus"></i> Task</button>
            <div class="sync-status offline" id="sync-status"></div>
            <i class="fas fa-cog settings-icon" onclick="showSettings()"></i>
        </div>
    </div>
    <div class="container">
        <div id="notes-page">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search Notes" oninput="searchNotes()">
                <button class="clear-btn" onclick="clearSearch()">&times;</button>
            </div>
            <div id="notes-list"></div>
        </div>
        <div id="tasks-page" class="hidden">
            <h2>High Impact Tasks</h2>
            <div id="high-impact-tasks"></div>
            <h2>Todo Tasks</h2>
            <div id="todo-tasks"></div>
            <h2>Done Tasks</h2>
            <div id="done-tasks"></div>
        </div>
        <div id="settings-page" class="hidden">
            <div class="modal" onclick="hideSettings()">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <span class="close" onclick="hideSettings()">&times;</span>
                    <h2>Settings</h2>
                    <input type="text" id="couchdb-url" placeholder="CouchDB URL"><br>
                    <input type="text" id="couchdb-username" placeholder="CouchDB Username"><br>
                    <input type="password" id="couchdb-password" placeholder="CouchDB Password"><br>
                    <button onclick="saveSettings()">Save Settings</button>
                    <button onclick="hideSettings()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="note-modal" class="modal hidden" onclick="hideNoteForm()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="hideNoteForm()">&times;</span>
            <h3>New Note</h3>
            <input type="text" id="note-title" placeholder="Title"><br>
            <textarea id="note-content" placeholder="Content"></textarea><br>
            <div id="note-tasks"></div>
            <button onclick="addNoteTask()">Add Task</button><br>
            <button onclick="saveNote()">Save Note</button>
            <button onclick="hideNoteForm()">Cancel</button>
        </div>
    </div>

    <div id="task-modal" class="modal hidden" onclick="hideTaskForm()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="hideTaskForm()">&times;</span>
            <h3>New Task</h3>
            <input type="text" id="task-desc" placeholder="Description"><br>
            <input type="date" id="task-due-date"><br>
            <select id="task-status">
                <option value="High Impact">High Impact</option>
                <option value="Todo">Todo</option>
            </select>
            <button onclick="saveTask()">Save Task</button>
            <button onclick="hideTaskForm()">Cancel</button>
        </div>
    </div>

    <div id="view-note-modal" class="modal hidden" onclick="hideViewNoteModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="hideViewNoteModal()">&times;</span>
            <h2 id="view-note-title"></h2>
            <div id="view-note-content" class="note-content"></div>
            <h3>Tasks</h3>
            <div id="view-note-tasks"></div>
            <button onclick="hideViewNoteModal()">Close</button>
        </div>
    </div>

    <script>
        let db = new PouchDB('notes_tasks');
        let remoteDb = null;
        const converter = new showdown.Converter();
        const statuses = ["High Impact", "Todo"];
        let notes = [];
        let tasks = [];
        let deletedItems = [];
        let editingNoteId = null;
        let editingTaskId = null;
        let fuse;

        function initFuse() {
            fuse = new Fuse(notes, {
                keys: ['title', 'content'],
                threshold: 0.3
            });
        }

        function showPage(page) {
            document.getElementById('notes-page').classList.add('hidden');
            document.getElementById('tasks-page').classList.add('hidden');
            document.getElementById(page + '-page').classList.remove('hidden');
            if (page === 'notes') {
                displayNotes();
            } else if (page === 'tasks') {
                displayTasks();
            }
        }

        function displayNotes(filteredNotes = notes) {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            filteredNotes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            filteredNotes.forEach(note => {
                const noteDiv = document.createElement('div');
                noteDiv.classList.add('note');
                noteDiv.innerHTML = `
                    <h3>${note.title}</h3>
                    <div class="note-content">${converter.makeHtml(note.content)}</div>
                    <small>Updated: ${new Date(note.updatedAt).toLocaleString()}</small>
                    <button class="task-button" onclick="editNoteModal('${note._id}'); event.stopPropagation();"><i class="fas fa-edit"></i></button>
                    <button class="task-button" onclick="deleteNoteModal('${note._id}'); event.stopPropagation();"><i class="fas fa-trash"></i></button>
                `;
                noteDiv.addEventListener('click', () => viewNoteModal(note));
                notesList.appendChild(noteDiv);
            });
        }

        function viewNoteModal(note) {
            document.getElementById('view-note-title').innerText = note.title;
            document.getElementById('view-note-content').innerHTML = converter.makeHtml(note.content);
            const noteTasksDiv = document.getElementById('view-note-tasks');
            noteTasksDiv.innerHTML = '';
            note.tasks.forEach(taskId => {
                const task = tasks.find(t => t._id === taskId);
                if (task) {
                    const taskDiv = document.createElement('div');
                    taskDiv.classList.add('task-card');
                    taskDiv.dataset.id = task._id;
                    taskDiv.innerHTML = `
                        <div class="task-header">
                            <span class="task-title ${task.isDone ? 'task-done' : ''}">${task.description}</span>
                        </div>
                        <div class="task-details">
                            <span>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : ''}</span>
                        </div>
                    `;
                    noteTasksDiv.appendChild(taskDiv);
                }
            });
            document.getElementById('view-note-modal').classList.remove('hidden');
        }

        function hideViewNoteModal() {
            document.getElementById('view-note-modal').classList.add('hidden');
        }

        function searchNotes() {
            const searchTerm = document.getElementById('search-input').value;
            if (!searchTerm) {
                displayNotes(notes);
                return;
            }
            const results = fuse.search(searchTerm);
            const filteredNotes = results.map(result => result.item);
            displayNotes(filteredNotes);
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            displayNotes(notes);
        }

        function showNoteForm(note) {
            document.getElementById('note-modal').class            .remove('hidden');
            document.getElementById('note-tasks').innerHTML = '';
            if (note) {
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-content').value = note.content;
                note.tasks.forEach(taskId => {
                    const task = tasks.find(t => t._id === taskId);
                    if (task) addNoteTask(task);
                });
                editingNoteId = note._id;
            } else {
                document.getElementById('note-title').value = '';
                document.getElementById('note-content').value = '';
                editingNoteId = null;
            }
        }

        function hideNoteForm() {
            document.getElementById('note-modal').classList.add('hidden');
        }

        async function saveNote() {
            const title = document.getElementById('note-title').value;
            const content = document.getElementById('note-content').value;
            const taskElements = document.querySelectorAll('#note-tasks .task');
            const noteTasks = [];
            for (const taskElement of taskElements) {
                const taskId = taskElement.dataset.id;
                if (taskId) {
                    noteTasks.push(taskId);
                } else {
                    const task = {
                        _id: uuid.v4(),
                        description: taskElement.querySelector('.task-desc').value,
                        isDone: false,
                        dueDate: taskElement.querySelector('.task-due-date').value,
                        status: taskElement.querySelector('.task-status').value,
                        updatedAt: new Date().toISOString(),
                        source: 'local',
                        type: 'task'
                    };
                    tasks.push(task);
                    noteTasks.push(task._id);
                    await db.put(task);
                }
            }
            const updatedAt = new Date().toISOString();
            if (editingNoteId) {
                const note = notes.find(n => n._id === editingNoteId);
                note.title = title;
                note.content = content;
                note.tasks = noteTasks;
                note.updatedAt = updatedAt;
                note.source = 'local';
                await db.put(note);
            } else {
                const note = {
                    _id: uuid.v4(),
                    title,
                    content,
                    tasks: noteTasks,
                    updatedAt,
                    source: 'local',
                    type: 'note'
                };
                notes.push(note);
                await db.put(note);
            }
            syncDataWithCouchDB();
            initFuse();
            hideNoteForm();
            displayNotes();
            displayTasks();
        }

        function addNoteTask(task) {
            const noteTasksDiv = document.getElementById('note-tasks');
            const taskDiv = document.createElement('div');
            taskDiv.classList.add('task');
            taskDiv.dataset.id = task ? task._id : '';
            taskDiv.innerHTML = `
                <input type="text" class="task-desc" placeholder="Task description" value="${task ? task.description : ''}">
                <input type="date" class="task-due-date" value="${task ? task.dueDate : ''}">
                <select class="task-status">
                    ${statuses.map(status => `<option value="${status}" ${task && task.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                </select>
            `;
            noteTasksDiv.appendChild(taskDiv);
        }

        function editNoteModal(id) {
            const note = notes.find(n => n._id === id);
            showNoteForm(note);
        }

        async function deleteNoteModal(id) {
            if (confirm("Are you sure you want to delete this note?")) {
                const note = notes.find(n => n._id === id);
                if (note) {
                    deletedItems.push({ _id: note._id, type: 'note', updatedAt: new Date().toISOString() });
                    notes = notes.filter(n => n._id !== id);
                    await db.remove(note);
                    await db.put({ _id: note._id, _deleted: true });
                    syncDataWithCouchDB();
                    initFuse();
                    displayNotes();
                    displayTasks();
                }
            }
        }

        function displayTasks() {
            const highImpactTasksList = document.getElementById('high-impact-tasks');
            const todoTasksList = document.getElementById('todo-tasks');
            const doneTasksList = document.getElementById('done-tasks');

            highImpactTasksList.innerHTML = '';
            todoTasksList.innerHTML = '';
            doneTasksList.innerHTML = '';

            tasks.forEach(task => {
                if (!task) return;  // Skip if task is undefined
                const taskDiv = document.createElement('div');
                taskDiv.classList.add('task-card');
                taskDiv.dataset.id = task._id;
                taskDiv.innerHTML = `
                    <div class="task-header">
                        <input type="checkbox" ${task.isDone ? 'checked' : ''} onclick="toggleTaskDone('${task._id}')">
                        <span class="task-title ${task.isDone ? 'task-done' : ''}">${task.description}</span>
                        <div class="task-buttons">
                            <button class="task-button" onclick="editTask('${task._id}')"><i class="fas fa-edit"></i></button>
                            <button class="task-button" onclick="deleteTask('${task._id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="task-details">
                        <span>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : ''}</span>
                        ${task.noteId ? `<span class="related-note">Note: ${notes.find(n => n._id === task.noteId)?.title || ''}</span>` : ''}
                    </div>
                    <div class="task-action-buttons">
                        ${task.status === 'Todo' ? '<button class="task-button" onclick="changeTaskStatus(\'' + task._id + '\', \'High Impact\')">^ High Impact</button>' : ''}
                        ${task.status === 'High Impact' ? '<button class="task-button" onclick="changeTaskStatus(\'' + task._id + '\', \'Todo\')">v Todo</button>' : ''}
                    </div>
                `;

                if (task.isDone) {
                    doneTasksList.appendChild(taskDiv);
                } else if (task.status === 'High Impact') {
                    highImpactTasksList.appendChild(taskDiv);
                } else if (task.status === 'Todo') {
                    todoTasksList.appendChild(taskDiv);
                }
            });
        }

        async function changeTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t._id === taskId);
            if (task) {
                task.status = newStatus;
                task.updatedAt = new Date().toISOString();
                task.source = 'local';
                await db.put(task);
                syncDataWithCouchDB();
                displayTasks();
            }
        }

        function showTaskForm(task) {
            document.getElementById('task-modal').classList.remove('hidden');
            const statusSelect = document.getElementById('task-status');
            statusSelect.innerHTML = statuses.map(status => `<option value="${status}">${status}</option>`).join('');
            if (task) {
                document.getElementById('task-desc').value = task.description;
                document.getElementById('task-due-date').value = task.dueDate;
                statusSelect.value = task.status;
                editingTaskId = task._id;
            } else {
                document.getElementById('task-desc').value = '';
                document.getElementById('task-due-date').value = '';
                statusSelect.value = 'Todo';
                editingTaskId = null;
            }
        }

        function hideTaskForm() {
            document.getElementById('task-modal').classList.add('hidden');
        }

        async function saveTask() {
            const description = document.getElementById('task-desc').value;
            const dueDate = document.getElementById('task-due-date').value;
            const status = document.getElementById('task-status').value;
            const updatedAt = new Date().toISOString();
            if (editingTaskId) {
                const task = tasks.find(t => t._id === editingTaskId);
                task.description = description;
                task.dueDate = dueDate;
                task.status = status;
                task.updatedAt = updatedAt;
                task.source = 'local';
                await db.put(task);
            } else {
                const task = { _id: uuid.v4(), description, isDone: false, dueDate, status, updatedAt, source: 'local', type: 'task' };
                tasks.push(task);
                await db.put(task);
            }
            syncDataWithCouchDB();
            hideTaskForm();
            displayTasks();
            displayNotes();
        }

        async function toggleTaskDone(id) {
            const task = tasks.find(t => t._id === id);
            task.isDone = !task.isDone;
            task.updatedAt = new Date().toISOString();
            task.source = 'local';
            await db.put(task);
            syncDataWithCouchDB();
            displayTasks();
            displayNotes();
        }

        function editTask(id) {
            const task = tasks.find(t => t._id === id);
            showTaskForm(task);
        }

        async function deleteTask(id) {
            const task = tasks.find(t => t._id === id);
            if (task) {
                deletedItems.push({ _id: task._id, type: 'task', updatedAt: new Date().toISOString() });
               
                tasks = tasks.filter(t => t._id !== id);
                await db.remove(task);
                await db.put({ _id: task._id, _deleted: true });
                syncDataWithCouchDB();
                displayTasks();
                displayNotes();
            }
        }

        async function deleteAllNotesAndTasks() {
            if (confirm("Are you sure you want to delete all notes and tasks? This action cannot be undone.")) {
                for (const note of notes) {
                    deletedItems.push({ _id: note._id, type: 'note', updatedAt: new Date().toISOString() });
                    await db.remove(note);
                    await db.put({ _id: note._id, _deleted: true });
                }
                for (const task of tasks) {
                    deletedItems.push({ _id: task._id, type: 'task', updatedAt: new Date().toISOString() });
                    await db.remove(task);
                    await db.put({ _id: task._id, _deleted: true });
                }
                notes = [];
                tasks = [];
                syncDataWithCouchDB();
                displayNotes();
                displayTasks();
            }
        }

        function showSettings() {
            document.getElementById('settings-page').classList.remove('hidden');
        }

        function hideSettings() {
            document.getElementById('settings-page').classList.add('hidden');
        }

        function saveSettings() {
            localStorage.setItem('couchdbUrl', document.getElementById('couchdb-url').value);
            localStorage.setItem('couchdbUsername', document.getElementById('couchdb-username').value);
            localStorage.setItem('couchdbPassword', document.getElementById('couchdb-password').value);
            initCouchDBSync();
            hideSettings();
        }

        function updateSyncStatus(status) {
            const syncStatus = document.getElementById('sync-status');
            syncStatus.classList.remove('online', 'offline', 'syncing');
            syncStatus.classList.add(status);
        }

        async function syncDataWithCouchDB() {
            if (!remoteDb) {
                console.log('Remote CouchDB is not initialized');
                return;
            }

            updateSyncStatus('syncing');

            try {
                const result = await db.sync(remoteDb);
                console.log('Data synchronized successfully.', result);
                updateSyncStatus('online');
            } catch (error) {
                console.error('Data synchronization failed.', error);
                updateSyncStatus('offline');
            }
        }

        function initCouchDBSync() {
            const couchdbUrl = localStorage.getItem('couchdbUrl');
            const couchdbUsername = localStorage.getItem('couchdbUsername');
            const couchdbPassword = localStorage.getItem('couchdbPassword');

            if (!couchdbUrl || !couchdbUsername || !couchdbPassword) {
                console.log('CouchDB configuration is not complete');
                return;
            }

            remoteDb = new PouchDB(couchdbUrl, {
                auth: {
                    username: couchdbUsername,
                    password: couchdbPassword
                }
            });

            syncDataWithCouchDB();
            db.sync(remoteDb, {
                live: true,
                retry: true
            }).on('change', (info) => {
                console.log('Change detected', info);
                loadLocalData();
            }).on('paused', (err) => {
                console.log('Replication paused (e.g. replication up to date, user went offline)', err);
                if (!err) {
                    updateSyncStatus('online');
                }
            }).on('active', () => {
                console.log('Replication resumed (e.g. new changes replicating, user went back online)');
                updateSyncStatus('syncing');
            }).on('denied', (err) => {
                console.error('Replication denied', err);
                updateSyncStatus('offline');
            }).on('complete', (info) => {
                console.log('Replication complete', info);
            }).on('error', (err) => {
                console.error('Replication error', err);
                updateSyncStatus('offline');
            });
        }

        async function loadLocalData() {
            const allDocs = await db.allDocs({ include_docs: true });
            notes = allDocs.rows.filter(doc => doc.doc.type === 'note').map(doc => doc.doc);
            tasks = allDocs.rows.filter(doc => doc.doc.type === 'task').map(doc => doc.doc);
            deletedItems = allDocs.rows.filter(doc => doc.doc.type === 'deleted').map(doc => doc.doc);
            initFuse();
            displayNotes();
            displayTasks();
        }

        window.addEventListener('offline', () => {
            console.log('You are offline');
            updateSyncStatus('offline');
        });

        window.addEventListener('online', () => {
            console.log('You are online');
            updateSyncStatus('syncing');
            syncDataWithCouchDB();
        });

        // Initial setup
        showPage('notes');
        initFuse();
        loadLocalData();
        initCouchDBSync();
    </script>
</body>
</html>
